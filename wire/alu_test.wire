; ALU Test Harness - cycles through operations on each clock
; Demonstrates all ALU operations with fixed test values

module alu_test(clk) -> (result:4, zero, carry, op:3):
  ; Use a 3-bit counter for operation selection
  op = counter3(1, clk)

  ; Fixed test inputs (a=5, b=3)
  a = concat(0, 1, 0, 1)  ; 5 = 0b0101
  b = concat(0, 0, 1, 1)  ; 3 = 0b0011

  ; Run the ALU
  alu_out = alu4(a, b, op)
  result = alu_out.result
  zero = alu_out.zero
  carry = alu_out.carry

; 3-bit counter for cycling through operations
module counter3(en, clk) -> q:3:
  next = adder3(q, 1, 0)
  q = dff3(next.sum, clk)

; 3-bit adder
module adder3(a:3, b:3, cin) -> (sum:3, cout):
  ha0 = full_adder(a[0], b[0], cin)
  s0 = ha0.sum
  c0 = ha0.cout

  ha1 = full_adder(a[1], b[1], c0)
  s1 = ha1.sum
  c1 = ha1.cout

  ha2 = full_adder(a[2], b[2], c1)
  s2 = ha2.sum
  cout = ha2.cout

  sum = concat(s2, s1, s0)

; 3-bit D flip-flop
module dff3(d:3, clk) -> q:3:
  q0 = dff(d[0], clk)
  q1 = dff(d[1], clk)
  q2 = dff(d[2], clk)
  q = concat(q2, q1, q0)
